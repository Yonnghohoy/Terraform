Terraform Project

구성도
-----
![스크린샷 2024-04-18 151025](https://github.com/Yonnghohoy/Terraform/assets/88643834/c0040231-54e4-4a99-b0b9-b424d8ac9b87)

Flow
-----
1. Client가 hollyjunho.store 도메인으로 접근
2. CloudFront WAF에서 규칙인 "지역접근허용"을 사용하여 한국, 미국 국가에서만 접근이 가능하며, IP Rule을 통한 IP Allow, Drop.
3. ALB_WAF(Seoul)에서 요청 패킷 Header에 "hollyjunho" 값이 존재하는지 체크하여 있을 경우에만 통과
4. ALB에서 80포트로 요청오는 모든 통신을 443포트로 리다이렉트 및 ACM을 이용한 SSL 적용.
5. RoundRobin 방식으로 이중화된 다른 가용영역의 web 서버안의 nginx 페이지를 출력함.
6. A 가용 영역의 서버는 KMS, Secret Manager로 키가 관리되는 Aurora DB와 연결되어 DB통신 및 Aurora는 다른영역에 복제진행

Notice
-----
1. 위의 코드는 AWS내의 Rout53에서 구매한 것이 아닌 상황에서 작성한 코드이며, 구매한 도메인업체에 DNS 설정을 따로 하셔야합니다. (구매한 도메인업체에 Route53 zone의 NS값을 따로 설정해야함)
그 예로 ACM설정간 도메인인증 즉 CNAME에 대한 인증이 진행되어야 ACM 인증서를 발급 받을 수 있습니다.
- 전파가 느릴 시 TTL값을 조절하여 전파시간을 조절할 수 있습니다.
  
2. terraform.tfstate의 관리 및 버저닝, 동시작업 방지를 을 위해 S3 및  dynamoDB를 사용하며 table의 lock을 활용하여 협업 간의 동시작업을 방지합니다.


Module
-----
테라폼에서 모듈화는 코드를 재사용 가능한 조각으로 나누어서 관리하는 기술이며, 모듈화를 통해 코드를 조직화하고 중복을 줄여서 유지 보수를 쉽게 할 수 있으며, 여기에는 몇 가지 장점이 있습니다.

1. 재사용성: 모듈을 사용하여 코드를 작성하면 유사한 기능을 가진 여러 인프라 요소를 쉽게 생성할 수 있습니다. 이는 시간을 절약하고 코드를 더 재사용 가능하게 만듭니다.
2. 가독성: 모듈을 사용하면 코드가 더 읽기 쉽고 이해하기 쉬워집니다. 모듈은 특정 기능을 수행하는 논리적인 블록으로 그룹화되므로 코드의 구조를 명확하게 만듭니다.
3. 중복 제거: 모듈을 사용하여 중복 코드를 제거할 수 있습니다. 특정 인프라 패턴이나 구성을 여러 번 사용할 때, 해당 패턴이나 구성을 모듈로 추상화하여 중복을 최소화할 수 있습니다.
4. 유지 보수 용이성: 모듈화된 코드는 변경이 필요할 때 더 쉽게 관리할 수 있습니다. 모듈을 수정하면 해당 모듈을 사용하는 모든 곳에서 변경이 적용되므로 유지 보수가 더 효율적입니다.


루트 모듈(Root Module)
-----
루트 모듈은 테라폼 코드의 최상위 디렉토리에 위치한 모듈이며, 전체 인프라스트럭처를 정의하고, 다른 모듈을 호출하거나 연결하여 이 인프라스트럭처를 조립합니다.
보통 하나의 테라폼 실행(run)에는 하나의 루트 모듈이 포함되며, 이 루트 모듈은 main.tf, variables.tf, outputs.tf 등의 파일을 포함합니다.
루트 모듈은 특정 환경 또는 프로젝트에 대한 전체 인프라스트럭처를 정의하며, 보통 다수의 자식 모듈을 호출하여 필요한 리소스를 구성합니다.

자식 모듈(Child Module):
-----
자식 모듈은 루트 모듈 또는 다른 자식 모듈에서 호출되어 사용되는 모듈이며, 단일 기능을 수행하고, 보통 특정 리소스나 서비스에 대한 정의를 포함합니다.
모듈을 모듈화함으로써 코드의 재사용성을 높일 수 있으며, 자식 모듈은 특정 리소스나 서비스를 구성하는 일반적인 패턴을 캡슐화하고 코드의 중복을 줄이는 데 사용됩니다.
자식 모듈은 source 매개변수를 사용하여 호출됩니다. 이 매개변수에는 모듈의 경로(상대 경로 또는 URL)가 포함됩니다.


모듈통신의 흐름
-----
- 모듈통신의 예는 아래와 같습니다.
- 예를 들어 EC2생성시 VPC의 Subnet이 필요합니다. EC2모듈은 VPC모듈에서 생성된 Subnet값을 참고하기위해 VPC모듈의 outputs.tf에서 출력된 subnet값을 받아와야합니다.
1. VPC모듈에서 생성된 subnet값의 ID를 VPC모듈의 outputs.tf 파일로 말 그대로 Out시킨다 (밖으로 보낸다)

<VPC모듈>
output "aws_subnet_id" {
  value = aws_subnet.subnet.id
}

2. EC2모듈은 VPC모듈이 OUT시킨 값을 가져오기 위해 속 빈 껍데기를 variables.tf에 만든다. EC2를 생성하기 위한 필요한 객체인 subnet_id의 값은 variables.tf의 subnet_id를 참조하게 한다.
<EC2모듈의 variables.tf>
variable "subnet_id"{}

<EC2모듈의 maint.tf>
...
...
subnet_id = var.subnet_id


3. Root 모듈에서 EC2모듈을 호출하며 VPC Module을 참조하게 한다. 이때 VPC모듈에서 OUT 시킨 값의 이름을 참조하게 해야한다. "aws_subnet_id"
<Root모듈>
module "ec2" {
  ...
   ...
   ..
  subnet_id = module.vpc.aws_subnet_id
}
